const request = require('request');
const {JSDOM} = require('jsdom');

module.exports = function (username, parseDate) {
  const url = `https://github.com/${username}`;

  // Well, we use promises
  return new Promise((resolve, reject) => {

    // Get github content
    request.get(url, (error, response, body) => {

      if (error) {
        return reject({error});
      }

      if (response && response.statusCode !== 200) {
        return reject({
          error: 'Bad status code',
          statusCode: response.statusCode
        });
      }

      // Parse dom
      const dom = new JSDOM(body);

      // Check dom-parsing
      if (!dom.window || !dom.window.document) {
        return reject({error: 'Couldn\'t parse dom'});
      }

      // Find svg-chart
      const svgGraph = dom.window.document.getElementsByClassName('js-calendar-graph');
      if (svgGraph.length === 0) {
        return reject({error: 'Couldn\'t parse dom'});
      }

      // Parse days
      const daysRects = svgGraph[0].getElementsByClassName('day');
      if (daysRects.length === 0) {
        return reject({error: 'No contribution data found'});
      }

      const days = [];
      for (let d of daysRects) {
        days.push({
          date: parseDate ? new Date(d.getAttribute('data-date')) : d.getAttribute('data-date'),
          count: d.getAttribute('data-count')
        });
      }

      resolve({
        result: days
      });
    });
  });
};